<!DOCTYPE HTML>
<html lang="en">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="springCloud, Idea">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>springCloud | Idea</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.4.0"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"><script src="/js/prism.js"></script></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Idea</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>Index</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>Tags</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>About</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="Search" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Idea</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			Index
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			Tags
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			About
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/Snowmanazz" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/Snowmanazz" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/8.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">springCloud</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/springCloud/">
                                <span class="chip bg-color">springCloud</span>
                            </a>
                        
                            <a href="/tags/nacos/">
                                <span class="chip bg-color">nacos</span>
                            </a>
                        
                            <a href="/tags/Netfix/">
                                <span class="chip bg-color">Netfix</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>Publish Date:&nbsp;&nbsp;
                    2021-11-25
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>Word Count:&nbsp;&nbsp;
                    5.7k
                </div>
                

                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>Read Count:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="springCloud"><a href="#springCloud" class="headerlink" title="springCloud"></a>springCloud</h1><p>SpringCloud就是分布式微服务架构的一站式解决方案，多种微服务架构落地技术的集合体</p>
<p><img src="/2021/11/25/springCloud/p1.png"></p>
<p>比较重点的如下：</p>
<p><img src="/2021/11/25/springCloud/p2.png"></p>
<p>而现在由于各种组件的停更/升级/替换：</p>
<p><img src="/2021/11/25/springCloud/p3.png"></p>
<h1 id="Eureka服务注册与发现"><a href="#Eureka服务注册与发现" class="headerlink" title="Eureka服务注册与发现"></a>Eureka服务注册与发现</h1><p>SpringCloud封装了Netfix公司的Eureka实现服务治理</p>
<p>Eureka采用CS的设计架构，Eureka Server作为服务注册功能的服务器，它是服务注册中心。其他微服务使用Eureka的客户端连接到Eureka Server并维持心跳。</p>
<p><img src="/2021/11/25/springCloud/p4.png"></p>
<h2 id="Eureka两组件"><a href="#Eureka两组件" class="headerlink" title="Eureka两组件"></a>Eureka两组件</h2><ul>
<li><p>EurekaServer提供服务注册服务 <strong>@EnableEurekaServer</strong>：将服务信息注册进注册中心服务发现，从注册中心上获取服务信息</p>
</li>
<li><p>EurekaClient通过注册中心进行访问 <strong>@EnableEurekaClient</strong>：</p>
<ul>
<li>启动Eureka注册中心</li>
<li>启动服务提供者，然后把自身注册进Eureka</li>
<li>消费者调用时，使用服务器别名去注册中心获取实际的RPC远程调用地址</li>
<li>消费者获取服务地址后会缓存到本地jvm内存中，默认30s更新一次地址</li>
</ul>
</li>
</ul>
<p>操作：导入依赖，编写配置application.yml，启动类添加注解</p>
<pre class=" language-yml"><code class="language-yml">spring:
  application:
#    name: cloud-eureka-server7001
    name: cloud-eureka-servers  #集群需要一致
eureka:
  instance:
    hostname: www.eureka7001.com
  client:
    fetch-registry: true
    register-with-eureka: true
    service-url:
      defaultZone: http://www.eureka7002.com:7002/eureka/  #集群
      
#      fetch-registry: false  #不注册自己
#      register-with-eureka: false # 不检索自己
#      service-url:
#       defaultZone: http://www.eureka7001.com:7001/eureka/ #单机
  server:
    #关闭自我保护机制，保证不可用服务立即被踢出
    enable-self-preservation: false
    eviction-interval-timer-in-ms: 2000
</code></pre>
<p><a target="_blank" rel="noopener" href="http://localhost:7001/%E5%8F%AF%E4%BB%A5%E6%A3%80%E6%9F%A5">http://localhost:7001/可以检查</a></p>
<h2 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h2><p>在消费者的ApplicationContextConfig里的restTemplate方法上加上<code>@LoadBalanced</code>，开启负载均衡功能。</p>
<p>可自定义实现负载均衡机制</p>
<h2 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h2><p>在主配置类上加上<code>@EnableDiscoveryClient</code>注解，启用发现客户端。</p>
<pre><code>@Resource
private DiscoveryClient discoveryClient;    //springframework的DiscoveryClient
</code></pre>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/payment/discovery"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> Object <span class="token function">discovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//获取服务列表的信息</span>
    List<span class="token operator">&lt;</span>String<span class="token operator">></span> services <span class="token operator">=</span> discoveryClient<span class="token punctuation">.</span><span class="token function">getServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>String element <span class="token operator">:</span> services<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"*******element："</span> <span class="token operator">+</span> element<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//获取CLOUD-PAYMENT-SERVICE服务的所有具体实例</span>
    List<span class="token operator">&lt;</span>ServiceInstance<span class="token operator">></span> instances <span class="token operator">=</span> discoveryClient<span class="token punctuation">.</span><span class="token function">getInstances</span><span class="token punctuation">(</span><span class="token string">"CLOUD-PAYMENT-SERVICE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>ServiceInstance instance <span class="token operator">:</span> instances<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//getServiceId服务器id getHost主机名称 getPort端口号  getUri地址</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">getServiceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t"</span> <span class="token operator">+</span> instance<span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t"</span> <span class="token operator">+</span> instance<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t"</span> <span class="token operator">+</span> instance<span class="token punctuation">.</span><span class="token function">getUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>discoveryClient<span class="token punctuation">;</span>
<span class="token punctuation">}</span>    
</code></pre>
<h2 id="Eureka自我保护"><a href="#Eureka自我保护" class="headerlink" title="Eureka自我保护"></a>Eureka自我保护</h2><p>EurekaServer会尝试保护其服务注册表中的信息，不会删除数据也不会注销微服务。server的application.yml</p>
<p>#关闭自我保护，默认为true <code>enable-self-preservation: false</code><br>#心跳的间隔时间，单位毫秒  <code>eviction-interval-timer-in-ms: 2000</code></p>
<h1 id="Consul服务注册与发现"><a href="#Consul服务注册与发现" class="headerlink" title="Consul服务注册与发现"></a>Consul服务注册与发现</h1><p>Consul是一套开源的分布式服务发现与配置管理系统，由GO语言编写。</p>
<p>提供了微服务系统的服务治理，配置中心，控制总线等</p>
<h2 id="下载安装"><a href="#下载安装" class="headerlink" title="下载安装"></a>下载安装</h2><p>官网下载后有.exe的文件，<code>consul --version</code>查看版本 ，<code>consul agent -dev</code>使用开发者模式启动</p>
<p>启动之后访问 <a target="_blank" rel="noopener" href="http://localhost:8500/">http://localhost:8500</a></p>
<p>配置application.yml</p>
<pre class=" language-yml"><code class="language-yml">spring:
  application:
    name: consul-payment-service
  cloud:
    consul:
      host: localhost
      port: 8500
      discovery:
        service-name: ${spring.application.name}
</code></pre>
<p><img src="/2021/11/25/springCloud/p.png"></p>
<p><strong>集群中需要再RestTemplate的Bean上加@LoadBalanced注解</strong></p>
<h2 id="架构原理"><a href="#架构原理" class="headerlink" title="架构原理"></a>架构原理</h2><p><img src="/2021/11/25/springCloud/p5.png"></p>
<ul>
<li><p>consul节点在启动时可以定义自身角色，client、server两种。</p>
</li>
<li><p> client节点只负责转发外部请求，是无状态的；</p>
</li>
<li><p> server节点的职责是使用raft协议保证数据一致性，响应客户端的请求，维护集群状态，与其他数据中心交互。</p>
</li>
</ul>
<p>  节点之间通过gossip广播协议（谣言协议），进行节点之间的数据交互，最终大家达到一致</p>
<h1 id="Eureka、zookeeper、Consul"><a href="#Eureka、zookeeper、Consul" class="headerlink" title="Eureka、zookeeper、Consul"></a>Eureka、zookeeper、Consul</h1><table>
<thead>
<tr>
<th align="center">组件名</th>
<th align="center">语言</th>
<th align="center">CAP</th>
<th align="center">服务健康检查</th>
<th align="center">对外暴露接口</th>
<th align="center">spring cloud集成</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Eureka</td>
<td align="center">java</td>
<td align="center">AP</td>
<td align="center">可配支持</td>
<td align="center">HTTP</td>
<td align="center">已集成</td>
</tr>
<tr>
<td align="center">Consul</td>
<td align="center">Go</td>
<td align="center">CP</td>
<td align="center">支持</td>
<td align="center">HTTP/DNS</td>
<td align="center">已集成</td>
</tr>
<tr>
<td align="center">Zookeeper</td>
<td align="center">java</td>
<td align="center">CP</td>
<td align="center">支持</td>
<td align="center">客户端</td>
<td align="center">已集成</td>
</tr>
</tbody></table>
<p>CAP：一个分布式系统只能满足其二，P是必须满足的</p>
<p><img src="/2021/11/25/springCloud/CAP.png"></p>
<p>C:一致性（Consistency）A:可用性（Availability）P:分区容错性（Partition tolerance）</p>
<ul>
<li>CA：单点集群，可扩展性不大</li>
<li>CP：性能不是很高</li>
<li>AP：对一致性要求较低</li>
</ul>
<h1 id="Ribbon"><a href="#Ribbon" class="headerlink" title="Ribbon"></a>Ribbon</h1><p>负载均衡LoadBalance</p>
<p>Ngix是服务器负载均衡，Ribbon是本地负载均衡</p>
<h2 id="Ribbon负载均衡"><a href="#Ribbon负载均衡" class="headerlink" title="Ribbon负载均衡"></a>Ribbon负载均衡</h2><ul>
<li><strong>RoundRobinRule</strong>  轮询 （默认规则）</li>
<li><strong>RandomRule</strong>随机</li>
<li><strong>AvailabilityFilteringRule</strong> 会先过滤掉由多次访问故障而处于断路器跳闸状态的服务， 还有并发的连接数量超过阈值的服务，然后对剩余的服务列表按照轮询策略进行访问</li>
<li><strong>WeightedResponseTimeRule</strong> 根据平均响应时间计算所有服务的权重，响应时间越快服务权重越大被选中的概率越高。 刚启动时如果统计信息不足，则使用RoundRobinRule策略，等统计信息足够， 会切换到WeightedResponseTimeRule</li>
<li><strong>RetryRule</strong>先按照RoundRobinRule 的策略获取服务，如果获取服务失败则在指定时间内会进行重试，获取可用的服务</li>
<li><strong>BestAvailableRule</strong>  会先过滤掉由于多次访问故障而处于断路器跳闸状态的服务，然后选择一个并发量最小的服务</li>
<li><strong>ZoneAvoidanceRule</strong>  默认规则,复合判断server所在区域的性能和server的可用性选择服务器</li>
</ul>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MySelfRule</span>
<span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Bean</span>
  <span class="token keyword">public</span> IRule <span class="token function">myRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RandomRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//Ribbon默认是轮询，自定义为随机</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>在主启动类上添加：</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@RibbonClient</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"CLOUD-PAYMENT-SERVICE"</span><span class="token punctuation">,</span>configuration<span class="token operator">=</span>MySelfRule<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">//name表示对哪些服务进行负载均衡</span>
</code></pre>
<h2 id="RestTemplate和Ribbon"><a href="#RestTemplate和Ribbon" class="headerlink" title="RestTemplate和Ribbon"></a>RestTemplate和Ribbon</h2><p>在SpringCloud项目中，RestTemplate一般通过负责均匀来使用，其超时时间不能通过ribbon直接来设置，这样设置是无效的。</p>
<pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#ribbon的超时时间</span>
<span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
  <span class="token key atrule">ReadTimeout</span><span class="token punctuation">:</span> <span class="token number">3000 </span><span class="token comment" spellcheck="true">#读取超时时间</span>
  <span class="token key atrule">ConnectTimeout</span><span class="token punctuation">:</span> <span class="token number">3000  </span><span class="token comment" spellcheck="true">#连接超时时间</span>
  package com.atguigu.myrule;
    
</code></pre>
<p>restTemplate的超时时间可以在具体的客户端指定（java原生、apache客户端）。</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Bean</span>
  <span class="token keyword">public</span> RestTemplate <span class="token function">getRestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    SimpleClientHttpRequestFactory requestFactory <span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">SimpleClientHttpRequestFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    requestFactory<span class="token punctuation">.</span><span class="token function">setReadTimeout</span><span class="token punctuation">(</span><span class="token number">15000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//读取超时,单位ms</span>
    requestFactory<span class="token punctuation">.</span><span class="token function">setConnectTimeout</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//连接超时，单位ms</span>
    RestTemplate restTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span>requestFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> restTemplate<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre>
<p><strong>Ribbon配置的超时时间对RestTemplate不生效原因</strong>：</p>
<p><strong>RibbonClientConfiguration</strong>初始化<strong>IClientConfig</strong>源码：</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span>
<span class="token keyword">public</span> IClientConfig <span class="token function">ribbonClientConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    DefaultClientConfigImpl config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultClientConfigImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    config<span class="token punctuation">.</span><span class="token function">loadProperties</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//加载配置</span>
    config<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>CommonClientConfigKey<span class="token punctuation">.</span>ConnectTimeout<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//替换连接超时时间</span>
    config<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>CommonClientConfigKey<span class="token punctuation">.</span>ReadTimeout<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//替换请求超时时间</span>
    config<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>CommonClientConfigKey<span class="token punctuation">.</span>GZipPayload<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> config<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>所以，配置中的参数都呗覆盖掉了（但这不是最终原因），而是<strong>SimpleClientHttpRequestFactory</strong>，因为<strong>SimpleClientHttpRequestFactory</strong>会在request数据完全准备好了之后进行Connection的初始化，可以查看<strong>SimpleClientHttpRequestFactory</strong>方法<strong>prepareConnection</strong>源码：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">prepareConnection</span><span class="token punctuation">(</span>HttpURLConnection connection<span class="token punctuation">,</span> String httpMethod<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>connectTimeout <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        connection<span class="token punctuation">.</span><span class="token function">setConnectTimeout</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>connectTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//默认是-1</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>readTimeout <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        connection<span class="token punctuation">.</span><span class="token function">setReadTimeout</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>readTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//默认是-1</span>
    <span class="token punctuation">}</span>

    connection<span class="token punctuation">.</span><span class="token function">setDoInput</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"GET"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>httpMethod<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        connection<span class="token punctuation">.</span><span class="token function">setInstanceFollowRedirects</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        connection<span class="token punctuation">.</span><span class="token function">setInstanceFollowRedirects</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">"POST"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>httpMethod<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token string">"PUT"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>httpMethod<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token string">"PATCH"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>httpMethod<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token string">"DELETE"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>httpMethod<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        connection<span class="token punctuation">.</span><span class="token function">setDoOutput</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        connection<span class="token punctuation">.</span><span class="token function">setDoOutput</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    connection<span class="token punctuation">.</span><span class="token function">setRequestMethod</span><span class="token punctuation">(</span>httpMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>Feign调用接口分两层即：ribbon的调用和hystrix的调用，</strong><br><strong>所以ribbon的超时时间和Hystrix的超时时间的结合就是Feign的超时时间</strong></p>
<pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
    <span class="token key atrule">MaxAutoRetries</span><span class="token punctuation">:</span> <span class="token number">1 </span><span class="token comment" spellcheck="true">#最大重试次数，当Eureka中可以找到服务，但是服务连不上时将会重试</span>
    <span class="token key atrule">MaxAutoRetriesNextServer</span><span class="token punctuation">:</span> <span class="token number">1 </span><span class="token comment" spellcheck="true">#切换实例的重试次数</span>
    <span class="token key atrule">OkToRetryOnAllOperations</span><span class="token punctuation">:</span> <span class="token boolean important">false </span><span class="token comment" spellcheck="true"># 对所有的操作请求都进行重试，如果是get则可以，如果是post,put等操作没有实现幂等的情况下是很危险的，所以设置为false</span>
    <span class="token key atrule">ConnectTimeout</span><span class="token punctuation">:</span> <span class="token number">1000 </span><span class="token comment" spellcheck="true">#请求连接的超时时间</span>
    <span class="token key atrule">ReadTimeout</span><span class="token punctuation">:</span> <span class="token number">1800 </span><span class="token comment" spellcheck="true">#请求处理的超时时间</span>
    
<span class="token key atrule">hystrix</span><span class="token punctuation">:</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span>
        <span class="token key atrule">default</span><span class="token punctuation">:</span>
            <span class="token key atrule">execution</span><span class="token punctuation">:</span>
                <span class="token key atrule">isolation</span><span class="token punctuation">:</span>
                    <span class="token key atrule">thread</span><span class="token punctuation">:</span>
                        <span class="token key atrule">timeoutInMilliseconds</span><span class="token punctuation">:</span> <span class="token number">3000</span>
        <span class="token comment" spellcheck="true">#如果配置ribbon的重试，hystrix的超时时间要大于ribbon的超时时间，ribbon才会重试</span>
        <span class="token comment" spellcheck="true">#hystrix的超时时间>(1 + MaxAutoRetries + MaxAutoRetriesNextServer) * ReadTimeout 比较好，具体看需求</span>
</code></pre>
<h1 id="OpenFeign服务接口调用"><a href="#OpenFeign服务接口调用" class="headerlink" title="OpenFeign服务接口调用"></a>OpenFeign服务接口调用</h1><p>调用一个微服务有两种方法：</p>
<ul>
<li>Feign ：接口+注解。可读性高</li>
<li>RestTemplate+Ribbon。效率高</li>
</ul>
<p>Feign是一个声明式的WebService客户端。使用方法就是定义一个服务接口然后加上注解</p>
<p>Feign集成了Ribbon，实现了负载均衡。<strong>接口+注解</strong></p>
<ul>
<li>主启动类加注解 <code>@EnableFeignClients</code></li>
<li>编写一个接口加注解 <code>@FeignClient(value = &quot;SPRINGCLOUD-PROVIDER-DEPT&quot;)//value值为服务器名称</code></li>
</ul>
<p><img src="/2021/11/25/springCloud/p6.png"></p>
<p>默认Feign客户端只等待一秒钟，超过则直接报错</p>
<pre class=" language-YML"><code class="language-YML">#设置feign客户端超时时间
ribbon:
    #指的是建立连接所用的时间
  ReadTimeout: 5000  #单位ms
  #建立连接后从服务器读取到可用资源的时间
  ConnectTimeout: 5000  #单位ms
logging:
  level:
    com.atguigu.springcloud.service.PaymentFeignService: debug
</code></pre>
<p><strong>远程接口的本地JDK Proxy代理实例</strong>，有以下特点：</p>
<p>（1）Proxy代理实例，实现了一个加 @FeignClient 注解的远程调用接口；</p>
<p>（2）Proxy代理实例，能在内部进行HTTP请求的封装，以及发送HTTP 请求；</p>
<p>（3）Proxy代理实例，能处理远程HTTP请求的响应，并且完成结果的解码，然后返回给调用者。</p>
<h1 id="Hystrix断路器"><a href="#Hystrix断路器" class="headerlink" title="Hystrix断路器"></a>Hystrix断路器</h1><p>多个微服务相互调用容易发生服务雪崩</p>
<p>Hystrix用于处理分布式系统的延迟和容错的开源库，保证出现问题时，不会导致服务器整体崩溃，避免级联故障，提供分布式系统的弹性。</p>
<p>Hystrix设计目标：</p>
<ul>
<li>对来自依赖的延迟和故障进行防护和控制——这些依赖通常都是通过网络访问的</li>
<li>阻止故障的连锁反应</li>
<li>快速失败并迅速恢复</li>
<li>回退并优雅降级</li>
<li>提供近实时的监控与告警</li>
</ul>
<p>Hystrix遵循的设计原则：</p>
<ul>
<li>防止任何单独的依赖耗尽资源（线程）</li>
<li>过载立即切断并快速失败，防止排队</li>
<li>尽可能提供回退以保护用户免受故障</li>
<li>使用隔离技术（例如隔板，泳道和断路器模式）来限制任何一个依赖的影响</li>
<li>通过近实时的指标，监控和告警，确保故障被及时发现</li>
<li>通过动态修改配置属性，确保故障及时恢复</li>
<li>防止整个依赖客户端执行失败，而不仅仅是网络通信</li>
</ul>
<p><img src="/2021/11/25/springCloud/p12.png"></p>
<h2 id="压力测试："><a href="#压力测试：" class="headerlink" title="压力测试："></a>压力测试：</h2><p>工具 ：Jrebel</p>
<p>测试地址：<a target="_blank" rel="noopener" href="http://localhost:8001/payment/info/error/4%EF%BC%8C20000%E9%AB%98%E5%B9%B6%E5%8F%91%E8%AE%BF%E9%97%AE">http://localhost:8001/payment/info/error/4，20000高并发访问</a></p>
<p><img src="/2021/11/25/springCloud/p7.png"></p>
<p>新建一个HTTP请求测试：</p>
<p><img src="/2021/11/25/springCloud/p8.png"></p>
<p>测试可以发现：<a target="_blank" rel="noopener" href="http://localhost:8001/payment/info/ok/4%E8%AF%A5%E5%9C%B0%E5%9D%80%E8%AE%BF%E9%97%AE%E4%B9%9F%E4%BC%9A%E5%8F%98%E6%85%A2">http://localhost:8001/payment/info/ok/4该地址访问也会变慢</a></p>
<h2 id="服务降级："><a href="#服务降级：" class="headerlink" title="服务降级："></a>服务降级：</h2><p>当服务不可用的时候，不会被等待，直接返回一个友好的提示</p>
<ul>
<li>提供者fallback：一旦调用方法失败后并抛出错误信息后，会自动调用HystrixCommand中的fallbackMethod的指定的方法</li>
</ul>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">//@HystrixCommand:启用hystrix</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@HystrixCommand</span><span class="token punctuation">(</span>fallbackMethod <span class="token operator">=</span> <span class="token string">"getPaymentInfo_ErrorHandler"</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//失败后调用的方法</span>
                    commandProperties <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>
              name <span class="token operator">=</span> <span class="token string">"execution.isolation.thread.timeoutInMilliseconds"</span><span class="token punctuation">,</span>value <span class="token operator">=</span> <span class="token string">"3000"</span><span class="token punctuation">)</span>
              <span class="token comment" spellcheck="true">//设置超时时间的峰值3s</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> String <span class="token function">getPaymentInfo_Error</span><span class="token punctuation">(</span>Integer id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">//        return Thread.currentThread().getName()+"----ERROR----"+id;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"-----------error----------"</span><span class="token operator">+</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Integer timeout <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"-----getPaymentInfo_Error----ERROR----"</span><span class="token operator">+</span>id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>fallback方法：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> String <span class="token function">getPaymentInfo_ErrorHandler</span><span class="token punctuation">(</span>Integer id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"-----------getPaymentInfo_ErrorHandler----ERROR----"</span><span class="token operator">+</span>id<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>application.yml开启hysrix</p>
<pre class=" language-yml"><code class="language-yml">feign:
  hystrix:
    enabled: true  #在feign中开启hystrix
</code></pre>
<ul>
<li>消费者fallback</li>
</ul>
<p>接口的FeignClient注解添加fallback类</p>
<pre class=" language-java"><code class="language-java">fallback <span class="token operator">=</span> PaymentFallbackHystrixService<span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token comment" spellcheck="true">//FeignClient属性</span>
</code></pre>
<p>实现接口方法：</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Component</span>   <span class="token comment" spellcheck="true">//将fallback接口添加到容器中</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PaymentFallbackHystrixService</span> <span class="token keyword">implements</span> <span class="token class-name">PaymentHystrixService</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//对用方法的fallback方法</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> String <span class="token function">paymentInfo_OK</span><span class="token punctuation">(</span>Integer id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">"-------PaymentFallbackService fall back-paymentInfo_OK,o(╥﹏╥)o"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> String <span class="token function">paymentInfo_ERROR</span><span class="token punctuation">(</span>Integer id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">"-------PaymentFallbackService fall back-paymentInfo_TimeOut,o(╥﹏╥)o"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>这样可以实现解耦，避免代码臃肿</p>
<h2 id="服务熔断："><a href="#服务熔断：" class="headerlink" title="服务熔断："></a>服务熔断：</h2><p>当服务器达到最大的承受能的之后，直接拒绝访问服务，最会调用服务降级方法，返回友好提示。目的是保证服务不被宕机掉    </p>
<p><img src="/2021/11/25/springCloud/p9.png"></p>
<p><a target="_blank" rel="noopener" href="https://martinfowler.com/bliki/CircuitBreaker.html">https://martinfowler.com/bliki/CircuitBreaker.html</a></p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//---服务的熔断</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@HystrixCommand</span><span class="token punctuation">(</span>
            fallbackMethod <span class="token operator">=</span> <span class="token string">"paymentCircuitBreaker_fallback"</span><span class="token punctuation">,</span>commandProperties <span class="token operator">=</span>
        <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"circuitBreaker.enabled"</span><span class="token punctuation">,</span>value <span class="token operator">=</span> <span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//是否开启断路</span>
  <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"circuitBreaker.requestVolumeThreshold"</span><span class="token punctuation">,</span>value <span class="token operator">=</span> <span class="token string">"10"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//请求次数</span>
  <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"circuitBreaker.sleepWindowInMilliseconds"</span><span class="token punctuation">,</span>value <span class="token operator">=</span> <span class="token string">"10000"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//时间窗口期</span>
  <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"circuitBreaker.errorThresholdPercentage"</span><span class="token punctuation">,</span>value <span class="token operator">=</span> <span class="token string">"60"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">//失败率达到多少后跳闸</span>
    <span class="token comment" spellcheck="true">// 10s中的时间每访问10次失败率达到60%则断路</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">public</span> String <span class="token function">paymentCircuitBreaker</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> Integer id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>id<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"******id不能为负数"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        String simpleUUID <span class="token operator">=</span> IdUtil<span class="token punctuation">.</span><span class="token function">simpleUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"\t"</span> <span class="token operator">+</span> <span class="token string">"成功调用，流水号是："</span> <span class="token operator">+</span> simpleUUID<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> String <span class="token function">paymentCircuitBreaker_fallback</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> Integer id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">"id不能为负数，请稍后再试............"</span><span class="token operator">+</span>id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<h2 id="服务限流："><a href="#服务限流：" class="headerlink" title="服务限流："></a>服务限流：</h2><p>alibaba中sentient</p>
<h2 id="服务监控："><a href="#服务监控：" class="headerlink" title="服务监控："></a>服务监控：</h2><p>准实时的调用监控</p>
<p>在启动类中：加上<code>@EnableHystrixDashboard</code>注解即可</p>
<p>需要监控的启动类中加入：</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
 * 此配置是为了服务监控而配置，与服务容错本身无关，springcloud升级后的坑
 * ServletRegistrationBean因为springboot的默认路径不是/hystrix.stream
 * 只要在自己的项目里配置下面的Servlet就可以了
 * @return
 */</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> ServletRegistrationBean <span class="token function">getServlet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    HystrixMetricsStreamServlet streamServlet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HystrixMetricsStreamServlet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ServletRegistrationBean registrationBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServletRegistrationBean</span><span class="token punctuation">(</span>streamServlet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    registrationBean<span class="token punctuation">.</span><span class="token function">setLoadOnStartup</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    registrationBean<span class="token punctuation">.</span><span class="token function">addUrlMappings</span><span class="token punctuation">(</span><span class="token string">"/hystrix.stream"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    registrationBean<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"HystrixMetricsStreamServlet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> registrationBean<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>正常情况<img src="/2021/11/25/springCloud/p10.png"></p>
<p>错误情况<img src="/2021/11/25/springCloud/p11.png"></p>
<h1 id="路由网关Gateway-zuul"><a href="#路由网关Gateway-zuul" class="headerlink" title="路由网关Gateway/zuul"></a>路由网关Gateway/zuul</h1><p>已一种简单有效的方式对API进行路由，提供一些强大的功能，例如：熔断，限流，重试，代理</p>
<ul>
<li>路由：构建网关的基本模块，由ID、URI，断言和过滤器组成，断言为true则匹配该路由</li>
<li>断言：匹配HTTP请求 的所有内容，请求与断言匹配则进行路由</li>
<li>过滤：请求被路由前或路由后对请求进行修改</li>
</ul>
<pre class=" language-yml"><code class="language-yml">spring:
  application:
    name: cloud-gateway-service
  cloud:
    gateway:
      routes:
        - id: payment_routh
          uri: http://localhost:8001  #匹配后提供服务的路由地址
#          uri: lb://cloud-payment-service
          predicates:
            - Path=/payment/selectOne/**         #断言，路径相匹配的进行路由
        - id: payment_routh2
          uri: http://localhost:8001
#          uri: lb://cloud-payment-service
          predicates:
            - Path=/payment/lb/**
      discovery:
        locator:
          enabled: true  #开启从注册中心动态生成路由的功能，用微服务名进行路由
</code></pre>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span>    <span class="token class-name">GateWayConfig</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//访问localhost://9527/guonei跳转到baidu的guonei</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> RouteLocator <span class="token function">customRouteLocator</span><span class="token punctuation">(</span>RouteLocatorBuilder builder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        RouteLocatorBuilder<span class="token punctuation">.</span>Builder routes <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        routes<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">"path_route"</span><span class="token punctuation">,</span>r<span class="token operator">-</span><span class="token operator">></span>r<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">"/guonei"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span><span class="token string">"https://www.baidu.com"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> routes<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-yml"><code class="language-yml">predicates:
  - Path=/payment/lb/**
  - After=2021-12-03T11:07:22.717+08:00[Asia/Shanghai] #在这个时间之后访问生效
  - Before=2021-12-03T11:07:22.717+08:00[Asia/Shanghai] #在这个时间之前访问生效
  - Btween=2021-12-03T11:07:22.717+08:00[Asia/Shanghai],2021-12-03T11:07:22.717+08:00[Asia/Shanghai] #在这个时间之间访问生效
  - Cookie=username,zzyy  #判断cookie
  - Header=X-Request-Id,\d+ #判断请求头
</code></pre>
<h2 id="GatewayFilter"><a href="#GatewayFilter" class="headerlink" title="GatewayFilter"></a>GatewayFilter</h2><p>生命周期：pre（业务逻辑前）/post（业务逻辑后）</p>
<p>种类：GatewayFilter（单一）/GlobalFileter（全局）</p>
<h3 id="自定义GlobalFilter："><a href="#自定义GlobalFilter：" class="headerlink" title="自定义GlobalFilter："></a>自定义GlobalFilter：</h3><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//自定义过滤器</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyGateWayFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span><span class="token punctuation">,</span> Ordered <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//过滤没有登陆的请求</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Mono<span class="token operator">&lt;</span>Void<span class="token operator">></span> <span class="token function">filter</span><span class="token punctuation">(</span>ServerWebExchange exchange<span class="token punctuation">,</span> GatewayFilterChain chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"**************come in MylogGateWayGilter:  "</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String uname <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueryParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token string">"uname"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>uname <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"********用户名为空，非法用户。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//设置响应状态码</span>
            exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span>HttpStatus<span class="token punctuation">.</span>NOT_ACCEPTABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//进入下个过滤链</span>
        <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//加载顺序，0最先 </span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h1 id="Config配置中心"><a href="#Config配置中心" class="headerlink" title="Config配置中心"></a>Config配置中心</h1><p>springCloud Config为微服务框架提供了集中化的外部配置支持。配置服务为不同的微服务提供一个中心化的外部配置</p>
<pre class=" language-yml"><code class="language-yml">spring:
  application:
    name: cloud-config-center
  cloud:
    config:
      server:
        git:
          uri: https://gitee.com/mingsama/springcloud-config.git #git仓库地址
          #私有仓库需要用户名密码
          search-paths:
            - springcloud-config
      label: master
</code></pre>
<p>application.yml是用户级的资源配置项</p>
<p>bootstrap.yml是系统级，优先级更高</p>
<p>客户端bootstrap.yml</p>
<pre class=" language-yml"><code class="language-yml">spring:
  application:
    name: config-client
  cloud:
    config:
      label: master  #分支名称
      name: config  #配置文件名称
      profile: dev  #读取后缀名称   上述三个综合http://localhost:3344/master/config-dev.yml
      uri: http://localhost:3344  #配置中心的地址
</code></pre>
<p>配置更改时Config服务端可直接刷新</p>
<h2 id="Config客户端动态刷新"><a href="#Config客户端动态刷新" class="headerlink" title="Config客户端动态刷新"></a>Config客户端动态刷新</h2><p>避免重启。</p>
<pre class=" language-yml"><code class="language-yml">#暴露监控端点
management:
  endpoints:
    web:
      exposure:
        include: "*"
</code></pre>
<p>Controller层中添加 <code>@RefreshScope</code></p>
<p><strong>改完之后需要发送post请求刷新3355</strong></p>
<pre class=" language-bash"><code class="language-bash">curl -X POST <span class="token string">"http://localhost:3355/actuator/refresh"</span>        
</code></pre>
<h1 id="BUS消息总线"><a href="#BUS消息总线" class="headerlink" title="BUS消息总线"></a>BUS消息总线</h1><p><strong>Bus支持两种消息代理：RabbitMQ和Kafka</strong></p>
<p>Bus配合Config可以实现配置全自动动态刷新</p>
<p>Bus能够管理和传播分布式系统之间的消息，可用于广播状态更改、事件推送等。通信通道</p>
<p>广播模式：</p>
<ul>
<li>利用消息总线触发一个客户端/bus/refresh，而刷新所有客户端</li>
<li>利用消息总线触发一个服务端的/bus/refresh，而刷新所有客户端（更合适）</li>
</ul>
<h2 id="给服务端添加消息总线支持：RabbitMQ"><a href="#给服务端添加消息总线支持：RabbitMQ" class="headerlink" title="给服务端添加消息总线支持：RabbitMQ"></a>给服务端添加消息总线支持：RabbitMQ</h2><p>服务端：</p>
<pre class=" language-yml"><code class="language-yml">spring:
  application:
    name: cloud-config-center
    #rabbitmq配置
  rabbitmq:
    host: localhost
    port: 15672
    username: guest
    password: guest
</code></pre>
<pre class=" language-yml"><code class="language-yml">#rabbitmq相关配置，暴露bus刷新配置的端点  必须添加actuator依赖！！！！！
management:
  endpoints:  #暴露bus刷新配置的端点
    web:
      exposure:
        include: 'bus-refresh'
</code></pre>
<p>客户端：</p>
<pre class=" language-yml"><code class="language-yml">spring:
  application:
    name: cloud-config-center
    #rabbitmq配置
  rabbitmq:
    host: localhost
    port: 15672
    username: guest
    password: guest
</code></pre>
<p>控制台输入：<code>curl -X POST &quot;http://localhost:3344/actuator/bus-refresh&quot;</code>即可全局生效</p>
<h2 id="定点通知"><a href="#定点通知" class="headerlink" title="定点通知"></a>定点通知</h2><p>指定name和port：</p>
<p><code>curl -X POST &quot;http://localhost:3344/actuator/bus-refresh/config-client:3366&quot;</code></p>
<h1 id="消息驱动Stream"><a href="#消息驱动Stream" class="headerlink" title="消息驱动Stream"></a>消息驱动Stream</h1><p>屏蔽底层中间件的差异，降低切换成本，统一消息 的编程模型</p>
<h2 id="Binder"><a href="#Binder" class="headerlink" title="Binder"></a>Binder</h2><p>通过绑定器Binder作为中简介，实现应用程序与消息中间件之间的隔离</p>
<p>Stream中的消息通信方式遵行发布-订阅模式  Topic</p>
<ul>
<li>inputing：消息输入通道</li>
<li>output：消息输出通道 </li>
<li>StreamListener：监听队列</li>
<li>EnableBinding：绑定队列和交换机</li>
</ul>
<h2 id="生产者："><a href="#生产者：" class="headerlink" title="生产者："></a>生产者：</h2><pre class=" language-yml"><code class="language-yml">spring:
  application:
    name: cloud-stream-privider
  cloud:
    stream:
      binders:   #自此处配置要绑定的rabbitmq的服务信息
        defaultRabbit: #表示定义的名称，用于binding整合
          type: rabbit #消息组件类型
          environment:  # 设置rabbitmq的相关的环境配置
            spring:
              rabbitmq:
                host: localhost
                port: 5672
                username: guest
                password: guest
      bindings:   #服务的整合处理
        output: #这个名字是一个通道的名称
          destination: studyExchange #表示要使用的exchange名称定义
          content-type: application/json #设置消息类型，本次为json
          binder: defaultRabbit  #设置要绑定的消息服务的具体设置
eureka:
  client:
    service-url:
      defaultZone: http://localhost:7001/eureka/
  instance:
    lease-expiration-duration-in-seconds: 5 #如果现在超过了5秒的间隔
    lease-renewal-interval-in-seconds: 2 #设置心跳的时间间隔
    instance-id: send-8801.com
    prefer-ip-address: true #访问的路径变为IP地址
</code></pre>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@EnableBinding</span><span class="token punctuation">(</span>Source<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//定义消息推送通道</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">IMessageService</span> <span class="token punctuation">{</span>

    <span class="token comment" spellcheck="true">//消息发送通道</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> MessageChannel output<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> String <span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        String serial <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        output<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>MessageBuilder<span class="token punctuation">.</span><span class="token function">withPayload</span><span class="token punctuation">(</span>serial<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"***********serial:"</span><span class="token operator">+</span>serial<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> serial<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="消费者："><a href="#消费者：" class="headerlink" title="消费者："></a>消费者：</h2><pre class=" language-yml"><code class="language-yml">spring:
  application:
    name: cloud-stream-privider
  cloud:
    stream:
      binders:   #自此处配置要绑定的rabbitmq的服务信息
        defaultRabbit: #表示定义的名称，用于binding整合
          type: rabbit #消息组件类型
          environment:  # 设置rabbitmq的相关的环境配置
            spring:
              rabbitmq:
                host: localhost
                port: 5672
                username: guest
                password: guest
      bindings:   #服务的整合处理
        input: #这个名字是一个通道的名称
          destination: studyExchange #表示要使用的exchange名称定义
          content-type: application/json #设置消息类型，本次为json
          binder: defaultRabbit  #设置要绑定的消息服务的具体设置
          group: atguiguA
eureka:
  client:
    service-url:
      defaultZone: http://localhost:7001/eureka/
  instance:
    lease-expiration-duration-in-seconds: 5 #如果现在超过了5秒的间隔
    lease-renewal-interval-in-seconds: 2 #设置心跳的时间间隔
    instance-id: send-8802.com
    prefer-ip-address: true #访问的路径变为IP地址
</code></pre>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@EnableBinding</span><span class="token punctuation">(</span>Sink<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReceiveMessageListenerController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${server.port}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> String serverPort<span class="token punctuation">;</span>


    <span class="token annotation punctuation">@StreamListener</span><span class="token punctuation">(</span>Sink<span class="token punctuation">.</span>INPUT<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">input</span><span class="token punctuation">(</span>Message<span class="token operator">&lt;</span>String<span class="token operator">></span> message<span class="token punctuation">)</span><span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"我是消费者1号，-----》接受到的消息是："</span><span class="token operator">+</span>message<span class="token punctuation">.</span><span class="token function">getPayload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"\t"</span><span class="token operator">+</span>serverPort<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre>
<h2 id="重复消费问题："><a href="#重复消费问题：" class="headerlink" title="重复消费问题："></a>重复消费问题：</h2><p>解决方式：消息分组 。同一个组只会消费一次</p>
<p>yml中添加           group：name #要想消费一次必须相同</p>
<p><strong>group属性可以防止服务重启后没有接收到的消息丢失</strong></p>
<h1 id="Sleuth分布式请求链路跟踪"><a href="#Sleuth分布式请求链路跟踪" class="headerlink" title="Sleuth分布式请求链路跟踪"></a>Sleuth分布式请求链路跟踪</h1><p>提供服务跟踪方案，兼容支持zipkin</p>
<p>启动zipkin ：<code>java -jar zipkin-server-2.23.9-exec.jar</code></p>
<p>访问：localhost:9411</p>
<p><strong>一条链路通过traceId唯一标识，Span标识发起的请求信息，各Span通过parentId 关联起来</strong></p>
<pre class=" language-yml"><code class="language-yml">spring:
  application:
    name: cloud-comsumer-order
    zipkin:
      base-url: http://localhost:9411
    sleuth:
      sampler:
        #采样值0-1，1标识全部采集
        probability: 1
</code></pre>
<h1 id="Nacos服务注册和配置中心"><a href="#Nacos服务注册和配置中心" class="headerlink" title="Nacos服务注册和配置中心"></a>Nacos服务注册和配置中心</h1><p>易于构建云原生应用的动态服务发现、配置管理和服务管理平台</p>
<p>nacos启动：<code>startup.cmd -m standalone</code></p>
<p>访问：<code>localhost:8848/nacos  账户密码都是nacos</code></p>
<h2 id="服务注册："><a href="#服务注册：" class="headerlink" title="服务注册："></a>服务注册：</h2><h3 id="生产者：-1"><a href="#生产者：-1" class="headerlink" title="生产者："></a>生产者：</h3><pre class=" language-yml"><code class="language-yml">spring:
  application:
    name: nacos-payment-provider
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848 #nacos地址
#暴露
management:
  endpoints:
    web:
      exposure:
        include: "*"
</code></pre>
<p>nacos自带负载均衡</p>
<h3 id="消费者：-1"><a href="#消费者：-1" class="headerlink" title="消费者："></a>消费者：</h3><pre class=" language-yml"><code class="language-yml">spring:
  application:
    name: cloud-nacos-order
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848

#消费者将要去访问的微服务名称
server-url:
  nacos-user-service: http://nacos-payment-provider
</code></pre>
<p>Nacos支持CP和AP的切换</p>
<h2 id="配置中心："><a href="#配置中心：" class="headerlink" title="配置中心："></a>配置中心：</h2><p>nacos中添加配置：</p>
<p><code>nacos-config-client-dev.yaml</code></p>
<p>bootstrap.yml:</p>
<pre class=" language-yml"><code class="language-yml">spring:
  application:
    name: nacos-config-client
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848  #Nacos服务注册中心地址
      config:
        server-addr: localhost:8848  #Nacos作为配置中心地址
        file-extension: yaml #指定yaml格式的配置
#        group: DEFAULT_GROUP   #对应的分组，默认default_group
#        namespace: 7a901d46-e75e-4e6a-b186-5980cca4249b  #新建的命名空间的ID

# ${spring.application.name}-${spring.profile.active}.${spring.cloud.nacos.config.file-extension}
#nacos-config-client-dev.yaml
</code></pre>
<p>application.yml:</p>
<pre class=" language-yml"><code class="language-yml">spring:
  profiles:
    active: dev
</code></pre>
<h2 id="持久化配置："><a href="#持久化配置：" class="headerlink" title="持久化配置："></a>持久化配置：</h2><p>默认Nacos使用的是嵌入式数据库实现数据的存储。Nacos采用了集中式存储的方法来支持集群化部署</p>
<p>需要将derby换成mysql数据库</p>
<h1 id="Sentinel熔断限流"><a href="#Sentinel熔断限流" class="headerlink" title="Sentinel熔断限流"></a>Sentinel熔断限流</h1><p>Hystrix：需要手工搭建监控平台，没有一套web化界面供我们配置</p>
<p>Sentinel：支持界面化的统一配置，可以独立出来</p>
<p><img src="/2021/11/25/springCloud/zz2.png"> </p>
<p>启动sentinel控制台：<code>java -jar sentinel-dashboard-1.8.2.jar</code> 访问：localhost:8080</p>
<pre class=" language-yml"><code class="language-yml">spring:
  application:
    name: cloudalibaba-sentinel-service
  cloud:
    nacos:
      discovery:
          #nacos服务注册中心地址
        server-addr: localhost:8848
    sentinel:
      transport:
          #配置sentinel dashboard地址
        dashboard: localhost:8080
        #默认8719地址，如果被占用则+1，直到可用
        port: 8719
      datasource:
        ds1:
          nacos:
            server-addr: localhost:8848
            dataId: ${spring.application.name}
            groupId: DEFAULT_GROUP
            data_type: json
            rule_type: flow
</code></pre>
<h2 id="流控规则："><a href="#流控规则：" class="headerlink" title="流控规则："></a>流控规则：</h2><ul>
<li><p>阈值类型/单机阈值：</p>
<ul>
<li><p>QPS（每秒钟的请求数量）:当调用该api的QPS达到阈值时，进行限流</p>
</li>
<li><p>线程数：当调用该api的线程数达到阈值时，进行限流</p>
</li>
</ul>
</li>
<li><p>流控模式：</p>
<ul>
<li>直接：api达到限流条件时，直接限流</li>
<li>关联：当关联的资源达到阈值，限流自己</li>
<li>链路: 只记录指定链路上的流量</li>
</ul>
</li>
<li><p>流控效果：</p>
<ul>
<li>快速失败：直接失败，抛出异常</li>
<li>Warm up：根据codeFactor（冷加载因子，默认3）的值，从 阈值/codeFactor，经过预热时长，才达到设置的QPS阈值</li>
</ul>
</li>
</ul>
<p><img src="/2021/11/25/springCloud/zz1.png"></p>
<p>每秒查询超过一次则立刻报错</p>
<h2 id="降级规则："><a href="#降级规则：" class="headerlink" title="降级规则："></a>降级规则：</h2><p><img src="/2021/11/25/springCloud/zz3.png"></p>
<ul>
<li>RT(平均响应时间)：平均响应时间超出阈值且在时间窗口内通过的请求&gt;=5，则触发降级。窗口期过后关闭断路器，RT最大4900，可设置</li>
<li>异常比例：QPS&gt;=5且异常比例超过阈值时，触发降级，时间窗口结束后，关闭降级</li>
<li>异常数：当资源近一分钟的异常数且超过阈值之后进行降级</li>
</ul>
<h2 id="热点规则："><a href="#热点规则：" class="headerlink" title="热点规则："></a>热点规则：</h2><p><img src="/2021/11/25/springCloud/zz4.png"></p>
<p>自定义兜底降级方法</p>
<p>从<strong>HystrixCommand</strong>到<strong>SentinelResource</strong></p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"testHotKey"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"testHotKey"</span><span class="token punctuation">,</span>blockHandler <span class="token operator">=</span> <span class="token string">"deal_testHotKet"</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">//blockHandler指定异常方法</span>
<span class="token comment" spellcheck="true">//sentinel系统默认提示：Blocked by Sentinel(flow limiting)</span>
<span class="token keyword">public</span> String <span class="token function">testHotKey</span><span class="token punctuation">(</span>
        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"p1"</span><span class="token punctuation">,</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> String p1<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"p2"</span><span class="token punctuation">,</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> String p2
<span class="token punctuation">)</span><span class="token punctuation">{</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"testHotKey 热点Key--测试"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> age <span class="token operator">=</span> <span class="token number">10</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//这个是RuntimeException，不归SentinelRescource管</span>
    <span class="token keyword">return</span> <span class="token string">"testHotKey-------"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> String <span class="token function">deal_testHotKet</span><span class="token punctuation">(</span>String p1<span class="token punctuation">,</span> String p2<span class="token punctuation">,</span> BlockException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">"----deal_testHotKet,------"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="系统规则："><a href="#系统规则：" class="headerlink" title="系统规则："></a>系统规则：</h2><p><img src="/2021/11/25/springCloud/zz5.png"></p>
<h2 id="SentinelResource"><a href="#SentinelResource" class="headerlink" title="SentinelResource:"></a>SentinelResource:</h2><p>自定义限流处理类：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Customerhandler</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> CommonResult <span class="token function">handlerException</span><span class="token punctuation">(</span>BlockException exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CommonResult</span><span class="token punctuation">(</span><span class="token number">444</span><span class="token punctuation">,</span><span class="token string">"按客户自定义，global handlerException"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Payment</span><span class="token punctuation">(</span>2020L<span class="token punctuation">,</span><span class="token string">"serial003"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> CommonResult <span class="token function">handlerException2</span><span class="token punctuation">(</span>BlockException exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CommonResult</span><span class="token punctuation">(</span><span class="token number">444</span><span class="token punctuation">,</span><span class="token string">"按客户自定义，global handlerException2"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Payment</span><span class="token punctuation">(</span>2020L<span class="token punctuation">,</span><span class="token string">"serial003"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="服务熔断功能："><a href="#服务熔断功能：" class="headerlink" title="服务熔断功能："></a>服务熔断功能：</h2><p>搭配ribbon+openfeign</p>
<ul>
<li><p>fallback：java异常</p>
</li>
<li><p>blockHandler：配置异常</p>
</li>
</ul>
<p>如果两个都配置，只会    进入blockHandler处理</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"fallback"</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//没有配置</span>
<span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"fallback"</span><span class="token punctuation">,</span>fallback <span class="token operator">=</span> <span class="token string">"handlerFallback"</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//fallback只负责业务异常</span>
<span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"fallback"</span><span class="token punctuation">,</span>blockHandler <span class="token operator">=</span> <span class="token string">"blockHandler"</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//blockHandler只负责sentine控制台配置违规</span>
<span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"fallback"</span><span class="token punctuation">,</span>fallback <span class="token operator">=</span> <span class="token string">"handlerFallback"</span><span class="token punctuation">,</span>blockHandler <span class="token operator">=</span> <span class="token string">"blockHandler"</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//handlerFallback和blockHandler都配置</span>
</code></pre>
<h2 id="SpringCloudAlibaba"><a href="#SpringCloudAlibaba" class="headerlink" title="SpringCloudAlibaba"></a>SpringCloudAlibaba</h2><ul>
<li>Nacos = Eureka/Consule + Config + Admin</li>
<li>Sentinel = Hystrix + Dashboard + Turbine</li>
<li>Dubbo = Ribbon + Feign</li>
<li>RocketMQ = RabbitMQ</li>
</ul>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        Author:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">Snowman</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        Link:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://snowmanazz.github.io/2021/11/25/springCloud/">http://snowmanazz.github.io/2021/11/25/springCloud/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        Reprint policy:
                    </i>
                </span>
                <span class="reprint-info">
                    All articles in this blog are used except for special statements
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    reprint policy. If reproduced, please indicate source
                    <a href="/about" target="_blank">Snowman</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>Copied successfully, please follow the reprint policy of this article</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">more</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/springCloud/">
                                    <span class="chip bg-color">springCloud</span>
                                </a>
                            
                                <a href="/tags/nacos/">
                                    <span class="chip bg-color">nacos</span>
                                </a>
                            
                                <a href="/tags/Netfix/">
                                    <span class="chip bg-color">Netfix</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;Previous</div>
            <div class="card">
                <a href="/2021/11/29/rabbitMQ/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/10.jpg" class="responsive-img" alt="rabbitMQ">
                        
                        <span class="card-title">rabbitMQ</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-11-29
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            Snowman
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/rabbitMQ/">
                        <span class="chip bg-color">rabbitMQ</span>
                    </a>
                    
                    <a href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">
                        <span class="chip bg-color">消息队列</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                Next&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/09/27/bigdata/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/22.jpg" class="responsive-img" alt="bigdata">
                        
                        <span class="card-title">bigdata</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-09-27
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            Snowman
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE%EF%BC%8Chadoop/">
                        <span class="chip bg-color">大数据，hadoop</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('100# 至少复制多少个字符就追加版权信息.')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE' || selection.getRangeAt(0).commonAncestorContainer.nodeName === 'CODE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + 'From: Idea<br />'
            + 'Author: Snowman<br />'
            + 'Link: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归snowmanazz所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;TOC</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2021</span>
            
            <span id="year">2021</span>
            <a href="/about" target="_blank">Snowman</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;Total visits:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;Total visitors:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
                <span id="sitetime"> Loading ...</span>
                <script>
                    var calcSiteTime = function () {
                        var seconds = 1000;
                        var minutes = seconds * 60;
                        var hours = minutes * 60;
                        var days = hours * 24;
                        var years = days * 365;
                        var today = new Date();
                        var startYear = "2021";
                        var startMonth = "7";
                        var startDate = "10";
                        var startHour = "0";
                        var startMinute = "0";
                        var startSecond = "0";
                        var todayYear = today.getFullYear();
                        var todayMonth = today.getMonth() + 1;
                        var todayDate = today.getDate();
                        var todayHour = today.getHours();
                        var todayMinute = today.getMinutes();
                        var todaySecond = today.getSeconds();
                        var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                        var diff = t2 - t1;
                        var diffYears = Math.floor(diff / years);
                        var diffDays = Math.floor((diff / days) - diffYears * 365);

                        // 区分是否有年份.
                        var language = 'en';
                        if (startYear === String(todayYear)) {
                            document.getElementById("year").innerHTML = todayYear;
                            var daysTip = 'This site has been running for ' + diffDays + ' days';
                            if (language === 'zh-CN') {
                                daysTip = '本站已运行 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                daysTip = '本站已運行 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = daysTip;
                        } else {
                            document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                            var yearsAndDaysTip = 'This site has been running for ' + diffYears + ' years and '
                                + diffDays + ' days';
                            if (language === 'zh-CN') {
                                yearsAndDaysTip = '本站已运行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                yearsAndDaysTip = '本站已運行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = yearsAndDaysTip;
                        }
                    }

                    calcSiteTime();
                </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/Snowmanazz" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:605407716@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=605407716" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 605407716" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;Search</span>
            <input type="search" id="searchInput" name="s" placeholder="Please enter a search keyword"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
