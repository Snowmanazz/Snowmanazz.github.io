<!DOCTYPE HTML>
<html lang="en">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="深入理解JAVA虚拟机, Idea">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>深入理解JAVA虚拟机 | Idea</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.4.0"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"><script src="/js/prism.js"></script></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Idea</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>Index</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>Tags</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>About</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="Search" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Idea</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			Index
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			Tags
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			About
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/Snowmanazz" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/Snowmanazz" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/18.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">深入理解JAVA虚拟机</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/java/">
                                <span class="chip bg-color">java</span>
                            </a>
                        
                            <a href="/tags/JVM/">
                                <span class="chip bg-color">JVM</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>Publish Date:&nbsp;&nbsp;
                    2021-07-30
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>Word Count:&nbsp;&nbsp;
                    6.7k
                </div>
                

                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>Read Count:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="Java虚拟机体系结构"><a href="#Java虚拟机体系结构" class="headerlink" title="Java虚拟机体系结构"></a>Java虚拟机体系结构</h1><p>java源代码被编译成class文件，而不是底层操作系统直接执行的二进制指令，因此，需要Java虚拟机（JVM）来解释Class文件并运行。</p>
<h1 id="JVM基本结构"><a href="#JVM基本结构" class="headerlink" title="JVM基本结构"></a>JVM基本结构</h1><h2 id="类加载器子系统"><a href="#类加载器子系统" class="headerlink" title="类加载器子系统"></a>类加载器子系统</h2><h3 id="类加载过程"><a href="#类加载过程" class="headerlink" title="类加载过程"></a>类加载过程</h3><p>加载——–》链接——–》初始化</p>
<p>当我们执行某个java程序（Test.class），只需要输入指令：<strong>Java</strong> <strong>Test</strong></p>
<ul>
<li>java.ex会找到JRE内部的jvm.dll，这个就是真正的java虚拟机器，然后加载动态库，激活java虚拟机器</li>
<li>激活后，会产生第一个类加载器—–<strong>Bootstrap Loader（启动类加载器）</strong></li>
<li>Bootstrap Loader的主要工作就是加载Launcher.java中的<strong>ExtClassLoader（扩展类加载器）</strong></li>
<li>然后加载Launcher.java中的<strong>AppClassLoader（用户自定义加载器）</strong>。这两个加载器都是静态类</li>
</ul>
<h3 id="类加载器体系结构"><a href="#类加载器体系结构" class="headerlink" title="类加载器体系结构"></a>类加载器体系结构</h3><p>JVM加载class文件必须通过类加载器，它的作用是从磁盘文件中将要运行代码的字节码流加载进内存（JVM管理的方法区中）</p>
<ul>
<li><strong>启动类加载器</strong>：负责在系统类（核心JavaAPI的class文件）的安装路径中查找要装入的类。由JVM实现</li>
<li><strong>扩展类加载器和用户自定义类加载器</strong>：负责JavaAPI以外的其他class文件的转载。由JVM实现</li>
<li><strong>命名空间</strong>：Java虚拟机为每一个类装载器维护一个唯一标识的命名空间</li>
</ul>
<h3 id="双亲委托模型"><a href="#双亲委托模型" class="headerlink" title="双亲委托模型"></a>双亲委托模型</h3><p>这是java.lang包下面的ClassLoader类中的loadClass方法</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> <span class="token function">loadClass</span><span class="token punctuation">(</span>string name<span class="token punctuation">)</span> <span class="token keyword">throws</span> ClassNotFoundException <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">loadClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">protected</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> <span class="token function">loadClass</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> <span class="token keyword">boolean</span> resolve<span class="token punctuation">)</span>
                                                <span class="token keyword">throws</span> ClassNotFoundException<span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 首先，检查是否已经被类加载器加我过</span>
        Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> c <span class="token operator">=</span> <span class="token function">findLoadedClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                 
                    c <span class="token operator">=</span> <span class="token function">findBootstrapClassOrNull</span><span class="token punctuation">(</span>name
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ClassNotFoundException thrown if class not found</span>
            <span class="token comment" spellcheck="true">// from the non-null parent class Loader</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// If still not found, then invoke findClass in order// to find the class.</span>
            c <span class="token operator">=</span> <span class="token function">findClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> c<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre>
<p><img src="/2021/07/30/JVM/class.png"></p>
<p><strong>除启动类装载器以外的每一个类装载器，都有一个“双亲”类装载器 ，在某个特定的类装载器试图以常用方式装载类型以前，它会先默认地将这个任务“委派”给它的双亲——请求它的双亲来装载这个类型。这个双亲再依次请求它自 己的双亲来装载这个类型。这个委派的过程一直向上继续，直到达到启动类装载器，通常启动类装载器是委派链中的最后一个类装载器。如果一个类装载器的双亲类 装载器有能力来装载这个类型。则这个类装载器返回这个类型。否则，这个类装载器试图自己来装载这个类</strong></p>
<p>实例:</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">;</span>  
  
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">String</span> <span class="token punctuation">{</span>  
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>  
          
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>  
</code></pre>
<p>这个代码中与JDK的String一模一样的类，包都一样，只是定义了一个main函数</p>
<p>结果：<img src="/2021/07/30/JVM/string.png"></p>
<p>所以运行这段代码：</p>
<ul>
<li><p>JVM会首先创建一个自定义类加载器（AppClassLoader），并把这个加载器链接到委托链中：AppClassLoader -&gt; ExtClassLoader -&gt; BootstrapLoader。</p>
</li>
<li><p> 然后AppClassLoader会将加载java.lang.String的请求委托给ExtClassLoader，而 ExtClassLoader又会委托给最后的启动类加载器BootstrapLoader。</p>
</li>
<li><p>启动类加载器BootstrapLoader只能加载JAVA_HOME\jre\lib中的class类(即J2SE API)，问题是标准API中确实有一个java.lang.String(注意，这个类和我们自定义的类是完全两个类)。BootstrapLoader以为找到了这个类，毫不犹豫的加载了j2se api中的java.lang.String。</p>
<p> 最后出现上面的加载错误(注意不是异常，是错误，JVM退出)，因为API中的String类是没有main方法的。</p>
</li>
</ul>
<h1 id="运行时区数据结构"><a href="#运行时区数据结构" class="headerlink" title="运行时区数据结构"></a>运行时区数据结构</h1><p><img src="/2021/07/30/JVM/jvma.png"></p>
<h2 id="程序计数器"><a href="#程序计数器" class="headerlink" title="程序计数器"></a>程序计数器</h2><p><strong>程序计数寄存器</strong>：存储指令相关的信息， 指向下一条指令的地址。由执行引擎读取</p>
<h2 id="虚拟机栈"><a href="#虚拟机栈" class="headerlink" title="虚拟机栈"></a>虚拟机栈</h2><p><strong>虚拟机栈</strong>：跨平台，指令集小，编译器易实现，内部保存栈帧.</p>
<h3 id="设置栈的大小："><a href="#设置栈的大小：" class="headerlink" title="设置栈的大小："></a>设置栈的大小：</h3><p>Java 虚拟机规范允许<strong>Java栈的大小是动态的或者是固定不变的。</strong></p>
<ul>
<li><p> 如果采用固定大小的Java虚拟机栈，Java虚拟机可能会抛出一个StackOverflowError 异常。 </p>
</li>
<li><p> 如果Java虚拟机栈可以动态扩展，并且在尝试扩展的时候无法申请到足够的内存，或者在创建新的线程时没有足够的内存去创建对应的虚拟机栈，那Java虚拟机将会抛出一个 OutOfMemoryError 异常。 </p>
</li>
</ul>
<p><strong>-Xss</strong>设置线程的最大栈空间。栈的大小决定了函数调用的最大可达深度</p>
<p><img src="/2021/07/30/JVM/stackSize.png"></p>
<h3 id="栈中的结构"><a href="#栈中的结构" class="headerlink" title="栈中的结构"></a>栈中的结构</h3><p>栈中有一个个栈帧，每个方法都对应一个栈帧，方法执行–入栈，方法结束–出栈</p>
<p>栈帧存储着 <strong>局部变量表、操作数栈、动态链接、方法返回地址以及一些附加信息</strong></p>
<h4 id="局部变量表"><a href="#局部变量表" class="headerlink" title="局部变量表"></a>局部变量表</h4><pre class=" language-bash"><code class="language-bash">LocalVariableTable:
    Start  Length  Slot  Name   Signature
      140      18    10     s   Ljava/lang/String<span class="token punctuation">;</span>
        0     162     0  args   <span class="token punctuation">[</span>Ljava/lang/String<span class="token punctuation">;</span>
        3     159     1 start_line   Ljava/lang/String<span class="token punctuation">;</span>
</code></pre>
<p>变量槽（slot）：32位以为的类型只占一个slot，64位的类型占两个slot（long，double）</p>
<p>变量的分类：</p>
<ul>
<li>按照数据类型：<ul>
<li>基本数据类型</li>
<li>引用数据类型</li>
</ul>
</li>
<li>类中声明的位置<ul>
<li>成员变量：<ul>
<li>类变量：linking的prepare阶段：赋默认值—》initial阶段，赋真实值</li>
<li>实例变量：随着对象的创建，在堆空间中分配实例变量空间，进行默认赋值</li>
</ul>
</li>
<li>局部变量：使用前，必须进行赋值，否则编译器报错</li>
</ul>
</li>
</ul>
<h2 id="堆"><a href="#堆" class="headerlink" title="堆"></a>堆</h2><p>一个JVM实例只存在一个堆内存，堆也是内存管理的核心区域。堆在jvm启动时就会确定大小</p>
<p>java7之前堆内存逻辑上分为：新生代+老年代+永久代</p>
<p><img src="/2021/07/30/JVM/jdk7.png"></p>
<p>java8之后堆内存逻辑上分为：新生代+老年代+元空间</p>
<p><img src="/2021/07/30/JVM/jdk8.png"></p>
<h3 id="堆内存的设置"><a href="#堆内存的设置" class="headerlink" title="堆内存的设置"></a>堆内存的设置</h3><ul>
<li><p>“**-Xms**”用于表示堆区的起始内存，等价于<code>-XX:InitialHeapSize</code></p>
</li>
<li><p>“**-Xmx**”则用于表示堆区的最大内存，等价于<code>-XX:MaxHeapSize</code>。超过则会报OutOfMemoryError</p>
</li>
</ul>
<p>通常会将-Xms和-Xmx两个参数配置相同的值，其目的是<strong>为了能够在ava垃圾回收机制清理完堆区后不需要重新分隔计算堆区的大小，从而提高性能。</strong></p>
<h3 id="年轻代与老年代"><a href="#年轻代与老年代" class="headerlink" title="年轻代与老年代"></a>年轻代与老年代</h3><p>堆空间细分</p>
<p><img src="/2021/07/30/JVM/heap1.png"></p>
<p>配置新生代与老年代在堆结构的占比。</p>
<ul>
<li><p>默认<code>-XX:NewRatio=2</code>，表示新生代占1，老年代占2，新生代占整个堆的1/3</p>
</li>
<li><p>可以修改<code>-XX:NewRatio=4</code>，表示新生代占1，老年代占4，新生代占整个堆的1/5</p>
</li>
</ul>
<p>在HotSpot中，Eden空间和另外两个survivor空间缺省所占的比例是8：1：1</p>
<p>几乎所有的Java对象都是在Eden区被new出来的。绝大部分的Java对象的销毁都在新生代进行了。</p>
<h3 id="对象分配内存过程"><a href="#对象分配内存过程" class="headerlink" title="对象分配内存过程"></a>对象分配内存过程</h3><ol>
<li> new的对象先放伊甸园区。此区有大小限制。</li>
<li> 当伊甸园的空间填满时，程序又需要创建对象，JVM的垃圾回收器将对伊甸园区进行垃圾回（MinorGC），将伊甸园区中的不再被其他对象所引用的对象进行销毁。再加载新的对象放到伊甸园区 </li>
<li> 然后将伊甸园中的剩余对象移动到幸存者0区。 </li>
<li> 如果再次触发垃圾回收，此时上次幸存下来的放到幸存者0区的，如果没有回收，就会放到幸存者1区。 </li>
<li> 如果再次经历垃圾回收，此时会重新放回幸存者0区，接着再去幸存者1区。 </li>
<li> 啥时候能去养老区。可以设置次数，默认是15次。设置<code>-Xx:MaxTenuringThreshold= N</code></li>
<li> 在养老区，相对悠闲。当养老区内存不足时，再次触发GC：Major GC，进行养老区的内存清理 </li>
<li> 若养老区执行了Major GC之后，发现依然无法进行对象的保存，就会产生OOM异常。  </li>
</ol>
<p><img src="/2021/07/30/JVM/heap2.png"></p>
<h3 id="GC分类"><a href="#GC分类" class="headerlink" title="GC分类"></a>GC分类</h3><ul>
<li><p>部分收集：不是完整收集整个Java堆的垃圾收集。其中又分为： </p>
</li>
<li><ul>
<li>新生代收集（Minor GC / Young GC）：只是新生代的垃圾收集</li>
</ul>
</li>
<li><ul>
<li>老年代收集（Major GC / Old GC）：只是老年代的圾收集。 </li>
</ul>
</li>
<li><ul>
<li><ul>
<li>目前，只有CMSGC会有单独收集老年代的行为。</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>注意，很多时候Major GC会和Full GC混淆使用，需要具体分辨是老年代回收还是整堆回收。</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li>混合收集（MixedGC）：收集整个新生代以及部分老年代的垃圾收集。 </li>
</ul>
</li>
<li><ul>
<li><ul>
<li>目前，只有G1 GC会有这种行为</li>
</ul>
</li>
</ul>
</li>
<li><p>整堆收集（Full GC）：收集整个java堆和方法区的垃圾收集。</p>
</li>
</ul>
<h3 id="堆空间参数设置"><a href="#堆空间参数设置" class="headerlink" title="堆空间参数设置"></a>堆空间参数设置</h3><pre class=" language-apl"><code class="language-apl"><span class="token function">-</span>XX<span class="token dfn builtin">:</span><span class="token function">+</span>PrintFlagsInitial  <span class="token monadic-operator operator">/</span><span class="token monadic-operator operator">/</span>查看所有的参数的默认初始值
<span class="token function">-</span>XX<span class="token dfn builtin">:</span><span class="token function">+</span>PrintFlagsFinal  <span class="token monadic-operator operator">/</span><span class="token monadic-operator operator">/</span>查看所有的参数的最终值（可能会存在修改，不再是初始值）
<span class="token function">-</span>Xms  <span class="token monadic-operator operator">/</span><span class="token monadic-operator operator">/</span>初始堆空间内存（默认为物理内存的<span class="token number">1</span><span class="token monadic-operator operator">/</span><span class="token number">64</span>）
<span class="token function">-</span>Xmx  <span class="token monadic-operator operator">/</span><span class="token monadic-operator operator">/</span>最大堆空间内存（默认为物理内存的<span class="token number">1</span><span class="token monadic-operator operator">/</span><span class="token number">4</span>）
<span class="token function">-</span>Xmn  <span class="token monadic-operator operator">/</span><span class="token monadic-operator operator">/</span>设置新生代的大小。（初始值及最大值）
<span class="token function">-</span>XX<span class="token statement">:NewRatio</span>  <span class="token monadic-operator operator">/</span><span class="token monadic-operator operator">/</span>配置新生代与老年代在堆结构的占比
<span class="token function">-</span>XX<span class="token statement">:SurvivorRatio</span>  <span class="token monadic-operator operator">/</span><span class="token monadic-operator operator">/</span>设置新生代中Eden和S<span class="token number">0</span><span class="token monadic-operator operator">/</span>S<span class="token number">1</span>空间的比例
<span class="token function">-</span>XX<span class="token statement">:MaxTenuringThreshold</span>  <span class="token monadic-operator operator">/</span><span class="token monadic-operator operator">/</span>设置新生代垃圾的最大年龄
<span class="token function">-</span>XX<span class="token dfn builtin">:</span><span class="token function">+</span>PrintGCDetails <span class="token monadic-operator operator">/</span><span class="token monadic-operator operator">/</span>输出详细的GC处理日志
<span class="token monadic-operator operator">/</span><span class="token monadic-operator operator">/</span>打印gc简要信息：①<span class="token function">-</span>Xx：<span class="token function">+</span>PrintGC ② <span class="token function">-</span> verbose<span class="token dfn builtin">:</span>gc
<span class="token function">-</span>XX<span class="token statement">:HandlePromotionFalilure</span>：<span class="token monadic-operator operator">/</span><span class="token monadic-operator operator">/</span>是否设置空间分配担保
</code></pre>
<h3 id="堆上分配对象是绝对的么"><a href="#堆上分配对象是绝对的么" class="headerlink" title="堆上分配对象是绝对的么"></a>堆上分配对象是绝对的么</h3><p>随着JIT编译期的发展与<strong>逃逸分析技术</strong>逐渐成熟，栈上分配、标量替换优化技术将会导致一些微妙的变化，所有的对象都分配到堆上也渐渐变得不那么“绝对”了。</p>
<p>在Java虚拟机中，对象是在Java堆中分配内存的，这是一个普遍的常识。但是，有一种特殊情况，那就是如果经过逃逸分析（Escape Analysis）后发现，一个对象并没有逃逸出方法的话，那么就可能被优化成栈上分配.。这样就无需在堆上分配内存，也无须进行垃圾回收了。这也是最常见的堆外存储技术。</p>
<h4 id="逃逸分析"><a href="#逃逸分析" class="headerlink" title="逃逸分析"></a>逃逸分析</h4><p>逃逸分析的基本行为就是分析对象动态作用域：</p>
<ul>
<li><p>当一个对象在方法中被定义后，对象只在方法内部使用，则认为没有发生逃逸。</p>
</li>
<li><p>当一个对象在方法中被定义后，它被外部方法所引用，则认为发生逃逸。例如作为调用参数传递到其他地方中。</p>
</li>
</ul>
<p>没有发生逃逸的对象，则可以分配到栈上，随着方法执行的结束，栈空间就被移除，每个栈里面包含了很多栈帧</p>
<h2 id="方法区"><a href="#方法区" class="headerlink" title="方法区"></a>方法区</h2><p>它用于存储已被虚拟机加载的类型信息、常量、静态变量、即时编译器编译后的代码缓存等。</p>
<p>栈、堆、方法区之间的关系</p>
<p><img src="/2021/07/30/JVM/m1.png"></p>
<p>方法区可以看作是一块独立于堆的内存空间</p>
<p><img src="/2021/07/30/JVM/j6.png"></p>
<p><img src="/2021/07/30/JVM/j7.png"></p>
<p><img src="/2021/07/30/JVM/j8.png"></p>
<p>不过元空间与永久代最大的区别在于<strong>：元空间不在虚拟机设置的内存中，而是使用本地内存</strong></p>
<p><img src="/2021/07/30/JVM/m.png"></p>
<h1 id="对象实例化"><a href="#对象实例化" class="headerlink" title="对象实例化"></a>对象实例化</h1><p><img src="/2021/07/30/JVM/d1.png"></p>
<h2 id="创建对象的步骤"><a href="#创建对象的步骤" class="headerlink" title="创建对象的步骤"></a>创建对象的步骤</h2><ul>
<li><strong>判断对象对应的类是否加载</strong>、<strong>链接</strong>、<strong>初始化</strong><ul>
<li>虚拟机遇到new指令，首先去检查这个指令的参数能否在Metaspace的常量池中定位到一个类的符号引用，并且检查这个符号引用代表的类是否已经被加载，解析和初始化。</li>
<li>如果没有被加载，会去找到该类对应的.class文件。</li>
<li>找到则进行加载，生成Class对象，否则抛出ClassNotFoundException异常。</li>
</ul>
</li>
<li><strong>为对象分配内存</strong><ul>
<li>计算对象占用空间的大小，在堆中划分一块内存给对象。如果实例成用变量是引用对象，仅分配引用变量空间即可，4个字节。</li>
<li>如果<strong>内存规整</strong>：虚拟机采用指针碰撞的方法分配内存</li>
<li>如果<strong>内存不规整</strong>：虚拟机会维护一个空闲列表来为对象分配内存</li>
</ul>
</li>
<li><strong>处理并发问题</strong><ul>
<li>采用CAS失败重、区域加锁保证更新的原子性</li>
<li>每个线程都会分配一块TLAB:  通过<code>-XX:+UseTLAB</code>参数设定</li>
</ul>
</li>
<li><strong>初始化分配到的内存</strong><ul>
<li>所有属性设置默认值，保证对象实例字段在不赋值时可直接使用</li>
</ul>
</li>
<li><strong>设置对象的对象头</strong><ul>
<li>将对象的所属类（即类的元数据信息）、对象的HashCode和对象的GC信息、锁信息等数据存储在对象的对象头中</li>
</ul>
</li>
<li><strong>执行init方法进行初始化</strong><ul>
<li>初始化成员变量，执行实例化代码块，调用类的构造方法，并把堆内对象的首地址赋值给引用变量。</li>
</ul>
</li>
</ul>
<h2 id="对象内存分布"><a href="#对象内存分布" class="headerlink" title="对象内存分布"></a>对象内存分布</h2><ul>
<li><strong>对象头</strong><ul>
<li>运行时元数据：哈希值、GC分代年龄、锁状态标志、线程持有的锁、偏向线程ID、时间戳</li>
<li>类型指针：指向元数据InstanceKlass，确定该对象所属的类型</li>
</ul>
</li>
<li><strong>实例数据</strong>：对象真正存储的有效信息</li>
<li><strong>对齐填充</strong>：起占位符的作用</li>
</ul>
<h2 id="StringTable"><a href="#StringTable" class="headerlink" title="StringTable"></a>StringTable</h2><p>String在jdk9中结构发生改变：<strong>String再也不用char[] 来存储了，改成了byte [] 加上编码标记</strong></p>
<p>使得内存占用的预期减少，GC活动的大幅减少，以及在某些角落情况下的轻微性能倒退。</p>
<h3 id="String的内存分配"><a href="#String的内存分配" class="headerlink" title="String的内存分配"></a>String的内存分配</h3><p>String声明的主要方法有两种：</p>
<ul>
<li>直接双引号声明的String会直接存储在常量池中</li>
<li>也可以用intern()指向</li>
</ul>
<p><strong>字符串传常量池存在堆中</strong></p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    String s1 <span class="token operator">=</span> <span class="token string">"a"</span><span class="token punctuation">;</span>
    String s2 <span class="token operator">=</span> <span class="token string">"b"</span><span class="token punctuation">;</span>
    String s3 <span class="token operator">=</span> <span class="token string">"ab"</span><span class="token punctuation">;</span>
    String s4 <span class="token operator">=</span> s1 <span class="token operator">+</span> s2<span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s3<span class="token operator">==</span>s4<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>我们拿例4的字节码进行查看，可以发现<code>s1 + s2</code>实际上是new了一个StringBuilder对象，并使用了append方法将s1和s2添加进来，最后调用了toString方法赋给s4</p>
<pre class=" language-shell"><code class="language-shell">0 ldc #2 <a>
2 astore_1
3 ldc #3 <b>
5 astore_2
6 ldc #4 <ab>
8 astore_3
9 new #5 <java/lang/StringBuilder>
12 dup
13 invokespecial #6 <java/lang/StringBuilder.<init>>
16 aload_1
17 invokevirtual #7 <java/lang/StringBuilder.append>
20 aload_2
21 invokevirtual #7 <java/lang/StringBuilder.append>
24 invokevirtual #8 <java/lang/StringBuilder.toString>
27 astore 4
29 getstatic #9 <java/lang/System.out>
32 aload_3
33 aload 4
35 if_acmpne 42 (+7)
38 iconst_1
39 goto 43 (+4)
42 iconst_0
43 invokevirtual #10 <java/io/PrintStream.println>
46 return
</code></pre>
<h3 id="intern-的使用"><a href="#intern-的使用" class="headerlink" title="intern()的使用"></a>intern()的使用</h3><p>当调用intern方法时，如果池子里已经包含了一个与这个String对象相等的字符串，正如equals(Object)方法所确定的，那么池子里的字符串会被返回。否则，这个String对象被添加到池中，并返回这个String对象的引用。</p>
<p>返回一个与此字符串内容相同的字符串，但保证是来自一个唯一的字符串池。</p>
<p>intern()是一个native方法，调用的是底层c的方法</p>
<p><strong>总结String的intern()的使用：</strong></p>
<p>JDK1.6中，将这个字符串对象尝试放入串池。</p>
<ul>
<li><p>如果串池中有，则并不会放入。返回已有的串池中的对象的地址</p>
</li>
<li><p>如果没有，会把此对象复制一份，放入串池，并返回串池中的对象地址</p>
</li>
</ul>
<p>JDK1.7起，将这个字符串对象尝试放入串池。</p>
<ul>
<li><p>如果串池中有，则并不会放入。返回已有的串池中的对象的地址</p>
</li>
<li><p>如果没有，则会把对象的引用地址复制一份，放入串池，并返回串池中的引用地址</p>
</li>
</ul>
<h1 id="垃圾回收"><a href="#垃圾回收" class="headerlink" title="垃圾回收"></a>垃圾回收</h1><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>指在运行过程中没有任何指针指向对象，那么这个对象就需要被回收</p>
<h2 id="垃圾收集器"><a href="#垃圾收集器" class="headerlink" title="垃圾收集器"></a>垃圾收集器</h2><p>Java堆是垃圾收集器的工作重点</p>
<ul>
<li><p>频繁收集Young区</p>
</li>
<li><p>较少收集Old区</p>
</li>
<li><p>基本不收集Perm区（元空间）</p>
</li>
</ul>
<h2 id="垃圾回收相关算法"><a href="#垃圾回收相关算法" class="headerlink" title="垃圾回收相关算法"></a>垃圾回收相关算法</h2><p>判断对象存活的两种方式：<strong>引用计数法</strong>和<strong>可达性分析算法</strong></p>
<h3 id="引用计数法（jvm没有采用）"><a href="#引用计数法（jvm没有采用）" class="headerlink" title="引用计数法（jvm没有采用）"></a>引用计数法（jvm没有采用）</h3><p>对每个对象保存一个整型的引用计数器属性，用于记录被引用的情况（被引用 +1，引用失效-1.为0时可进行回收）</p>
<p>优点：实现简单，垃圾对象便于辨识；判定效率高，回收没有延迟性。</p>
<p>缺点：</p>
<ul>
<li><p>它需要单独的字段存储计数器，这样的做法增加了存储空间的开销。</p>
</li>
<li><p>每次赋值都需要更新计数器，伴随着加法和减法操作，这增加了时间开销。</p>
</li>
<li><p>引用计数器有一个严重的问题，即<strong>无法处理循环引用</strong>的情况。这是一条致命缺陷，导致在Java的垃圾回收器中没有使用这类算法。</p>
</li>
</ul>
<h3 id="可达性分析算法（java、c-所选择的）"><a href="#可达性分析算法（java、c-所选择的）" class="headerlink" title="可达性分析算法（java、c#所选择的）"></a>可达性分析算法（java、c#所选择的）</h3><p>可以有效地解决循环引用的问题，防止内存泄露发生</p>
<ul>
<li>可达性分析算法是以根对象集合（GCRoots）为起始点，按从上到下的方式搜索被根对象集合所链接的目标对象是否可达</li>
<li>使用可达性算法分析后，内存中存活的对象会被根对象集合直接或间接的连接着， 搜索所走过的引用路径成为引用链</li>
<li>如果目标对象没有任何引用链相连，则是不可达的，就意味着对象已经死亡，可以标记为垃圾对象</li>
<li>只有被根对象集合直接或间接连接的才是存活的对象</li>
</ul>
<p><img src="/2021/07/30/JVM/m2.png"></p>
<h5 id="GCRoots中的元素分类"><a href="#GCRoots中的元素分类" class="headerlink" title="GCRoots中的元素分类"></a>GCRoots中的元素分类</h5><ul>
<li>虚拟机栈中引用的对象：各个线程被调用的方法中使用到的参数、局部变量等</li>
<li>本地方法栈内JNI引用的对象</li>
<li>方法区中静态属性、常量引用的对象</li>
<li>所有被synchronized持有的对象</li>
<li>java虚拟机内部的引用</li>
<li>反应java虚拟机内部情况的JMXBean、JVMTI中注册的回调、本地代码缓存等</li>
</ul>
<h2 id="对象的finalization机制"><a href="#对象的finalization机制" class="headerlink" title="对象的finalization机制"></a>对象的finalization机制</h2><p>Java语言提供了对象终止（finalization）机制来允许开发人员提供对象被销毁之前的自定义处理逻辑。</p>
<p><strong>垃圾回收此对象之前，总会先调用这个对象的finalize()方法。</strong></p>
<p>永远不要主动调用某个对象的finalize()方法I应该交给垃圾回收机制调用：</p>
<ul>
<li><p>在finalize()时可能会导致对象复活。</p>
</li>
<li><p>finalize()方法的执行时间是没有保障的，它完全由GC线程决定，极端情况下，若不发生GC，则finalize()方法将没有执行机会。</p>
</li>
<li><p>一个糟糕的finalize()会严重影响Gc的性能。</p>
</li>
</ul>
<h3 id="对象的状态"><a href="#对象的状态" class="headerlink" title="对象的状态"></a>对象的状态</h3><ul>
<li><p>可触及的：从根节点开始，可以到达这个对象。</p>
</li>
<li><p>可复活的：对象的所有引用都被释放，但是对象有可能在finalize()中复活。</p>
</li>
<li><p>不可触及的：对象的finalize()被调用，并且没有复活，那么就会进入不可触及状态。不可触及的对象不可能被复活，因为<strong>finalize()只会被调用一次。</strong></p>
</li>
</ul>
<h3 id="对象是否可回收"><a href="#对象是否可回收" class="headerlink" title="对象是否可回收"></a>对象是否可回收</h3><p>判定一个对象objA是否可回收，至少要经历两次标记过程：</p>
<ol>
<li><p>如果对象objA到GC Roots没有引用链，则进行第一次标记。</p>
</li>
<li><p>进行筛选，判断此对象是否有必要执行finalize()方法</p>
</li>
<li><p>如果对象objA没有重写finalize()方法，或者finalize()方法已经被虚拟机调用过，则虚拟机视为“没有必要执行”，objA被判定为不可触及的。</p>
</li>
<li><p>如果对象objA重写了finalize()方法，且还未执行过，那么objA会被插入到F-Queue队列中，由一个虚拟机自动创建的、低优先级的Finalizer线程触发其finalize()方法执行。</p>
</li>
<li><p>finalize()方法是对象逃脱死亡的最后机会，稍后GC会对F-Queue队列中的对象进行第二次标记。如果objA在finalize()方法中与引用链上的任何一个对象建立了联系，那么在第二次标记时，objA会被移出“即将回收”集合。之后，对象会再次出现没有引用存在的情况。在这个情况下，finalize方法不会被再次调用，对象会直接变成不可触及的状态，也就是说，一个对象的finalize方法只会被调用一次。</p>
</li>
</ol>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CanReliveObj</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 类变量，属于GC Roots的一部分</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> CanReliveObj canReliveObj<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"调用当前类重写的finalize()方法"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        canReliveObj <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>
        canReliveObj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CanReliveObj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        canReliveObj <span class="token operator">=</span> null<span class="token punctuation">;</span>
        System<span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"-----------------第一次gc操作------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 因为Finalizer线程的优先级比较低，暂停2秒，以等待它</span>
        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>canReliveObj <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"obj is dead"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"obj is still alive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"-----------------第二次gc操作------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        canReliveObj <span class="token operator">=</span> null<span class="token punctuation">;</span>
        System<span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 下面代码和上面代码是一样的，但是 canReliveObj却自救失败了</span>
        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>canReliveObj <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"obj is dead"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"obj is still alive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><img src="/2021/07/30/JVM/m3.png"></p>
<p>在第一次GC时，执行了finalize方法，但finalize()方法只会被调用一次，所以第二次该对象被GC标记并清除了</p>
<h2 id="清除阶段"><a href="#清除阶段" class="headerlink" title="清除阶段"></a>清除阶段</h2><h3 id="标记-清除算法"><a href="#标记-清除算法" class="headerlink" title="标记-清除算法"></a>标记-清除算法</h3><p>当堆中的有效内存空间耗尽时，就会停住整个程序，然后进行标记+清除：</p>
<ul>
<li>标记：Collecter从引用根节点开始遍历，标记所有被引用的对象</li>
<li>清除：Collecter对堆内存从头到尾进行线性的遍历，发现没有被标记，则会被回收</li>
</ul>
<p><img src="/2021/07/30/JVM/m4.png"></p>
<p>缺点：</p>
<ul>
<li><p>标记清除算法的效率不算高</p>
</li>
<li><p>在进行GC的时候，需要停止整个应用程序，用户体验较差</p>
</li>
<li><p>这种方式清理出来的空闲内存是不连续的，产生内碎片，需要维护一个空闲列表</p>
</li>
</ul>
<h3 id="复制算法"><a href="#复制算法" class="headerlink" title="复制算法"></a>复制算法</h3><p>将活着的内存空间分为两块，每次只使用其中一块，在垃圾回收时将正在使用的内存中的存活对象复制到未被使用的内存块中，之后清除正在使用的内存块中的所有对象，交换两个内存的角色，最后完成垃圾回收</p>
<p><img src="/2021/07/30/JVM/m5.png"></p>
<p><strong>优点</strong></p>
<ul>
<li><p>没有标记和清除过程，实现简单，运行高效</p>
</li>
<li><p>复制过去以后保证空间的连续性，不会出现“碎片”问题。</p>
</li>
</ul>
<p><strong>缺点</strong></p>
<ul>
<li><p>此算法的缺点也是很明显的，就是需要两倍的内存空间。</p>
</li>
<li><p>对于G1这种分拆成为大量region的GC，复制而不是移动，意味着GC需要维护region之间对象引用关系，不管是内存占用或者时间开销也不小</p>
</li>
</ul>
<h3 id="标记-压缩（整理）算法"><a href="#标记-压缩（整理）算法" class="headerlink" title="标记-压缩（整理）算法"></a>标记-压缩（整理）算法</h3><ol>
<li> 第一阶段和标记清除算法一样，从根节点开始标记所有被引用对象</li>
<li>  第二阶段将所有的存活对象压缩到内存的一端，按顺序排放。 </li>
<li> 之后，清理边界外所有的空间。</li>
</ol>
<p><img src="/2021/07/30/JVM/m7.png"></p>
<p>标记-压缩算法的最终效果等同于标记-清除算法执行完成后，再进行一次内存碎片整理，因此，也可以把它称为标记-清除-压缩（Mark-Sweep-Compact）算法。</p>
<table>
<thead>
<tr>
<th></th>
<th>Mark-Sweep</th>
<th>Mark-Compact</th>
<th>Copying</th>
</tr>
</thead>
<tbody><tr>
<td>速率</td>
<td>中等</td>
<td>最慢</td>
<td>最快</td>
</tr>
<tr>
<td>空间开销</td>
<td>少（堆积碎片）</td>
<td>少（无碎片）</td>
<td>通常需要活对象的两倍（无碎片）</td>
</tr>
<tr>
<td>移动对象</td>
<td>否</td>
<td>是</td>
<td>是</td>
</tr>
</tbody></table>
<h2 id="分代收集算法"><a href="#分代收集算法" class="headerlink" title="分代收集算法"></a>分代收集算法</h2><p>一般是把Java堆分为新生代和老年代，这样就可以根据各个年代的特点使用不同的回收算法，以提高垃圾回收的效率。</p>
<ul>
<li>年轻代特点：区域相对老年代较小，对象生命周期短、存活率低，回收频繁。复制算法</li>
<li>老年代特点：区域较大，对象生命周期长、存活率高，回收不及年轻代频繁。由标记-清除或者是标记-清除与标记-整理的混合实现。</li>
</ul>
<h1 id="JVM回收机制总结"><a href="#JVM回收机制总结" class="headerlink" title="JVM回收机制总结"></a>JVM回收机制总结</h1><p>java虚拟机中，数据类型分为两类：<strong>基本类型</strong>和<strong>引用类型</strong>，基本类型的值就是数值本身，引用类型表示的是是对某个对象的引用（存放的对象的地址）。</p>
<h2 id="堆和栈"><a href="#堆和栈" class="headerlink" title="堆和栈"></a>堆和栈</h2><p><strong>栈是运行时的单位，而堆是存储的单位</strong>。</p>
<p>也就是说栈是解决程序运行的问题，程序如何执行或者如何处理数据；而堆解决数据存储的问题，数据怎么存储，存储在哪里。</p>
<h3 id="那么为什么要把栈和堆分开呢？"><a href="#那么为什么要把栈和堆分开呢？" class="headerlink" title="那么为什么要把栈和堆分开呢？"></a>那么为什么要把栈和堆分开呢？</h3><ul>
<li><p>从软件设计的角度看，栈代表了处理逻辑 ，而堆代表了数据 。这样分开，使得处理逻辑更为清晰。分而治之的思想 。这种隔离、模块化的思想在软件设计的方方面面都有体现。</p>
</li>
<li><p>堆与栈的分离，使得堆中的内容可以被多个栈共享 （也可以理解为多个线程访问同一个对象）。这种共享的收益是很多的。一方面这种共享提供了一种有效的数据交互方式(如：共享内存)，另一方面，堆中的共享常量和缓存可以被所有栈访问，节省了空间。</p>
</li>
<li><p>栈因为运行时的需要，比如保存系统运行的上下文，需要进行地址段的划分。由于栈只能向上增长，因此就会限制住栈存储内容的能力。而堆不同，堆中的对象是可以根据需要动态增长的，因此栈和堆的拆分，使得动态增长成为可能 ，相应栈中只需记录堆中的一个地址即可。</p>
</li>
<li><p>面向对象就是堆和栈的完美结合 。</p>
</li>
</ul>
<h3 id="堆和栈分别存什么"><a href="#堆和栈分别存什么" class="headerlink" title="堆和栈分别存什么"></a>堆和栈分别存什么</h3><p>**堆中存的是对象 。栈中存的是基本数据类型 和堆中对象的引用 **</p>
<p>  为什么不把基本类型放堆中呢？因为其占用的空间一般是1~8个字节——需要空间比较少，而且因为是基本类型，所以不会出现动态增长的情况——长度固定，因此栈中存储就够了。</p>
<h3 id="java传递参数时，传值还是传引用"><a href="#java传递参数时，传值还是传引用" class="headerlink" title="java传递参数时，传值还是传引用"></a>java传递参数时，传值还是传引用</h3><p>Java在方法调用传递参数时，因为没有指针，所以<strong>它都是进行传值调用</strong> 。</p>
<p> <em>但是传引用的错觉是如何造成的呢？</em> 在运行栈中，基本类型和引用的处理是一样的，都是传值 ， 所以，如果是传引用的方法调用，也同时可以理解为“传引用值”的传值调用，即引用的处理跟基本类型是完全一样的</p>
<h3 id="java对象的大小"><a href="#java对象的大小" class="headerlink" title="java对象的大小"></a>java对象的大小</h3><p><strong>一个空Object对象的大小是8byte</strong> ，这个大小只是保存堆中一个没有任何属性的对象的大小</p>
<blockquote>
<p> Object obj=new Object();  //占用了4byte+8byte</p>
</blockquote>
<p>4byte是Java栈中保存引用的所需要的空间。而8byte则是Java堆中对象的信息。</p>
<pre class=" language-java"><code class="language-java">Class <span class="token class-name">NewObject</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> count<span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> flag<span class="token punctuation">;</span>
    Object ob<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//  其大小为：空对象大小(8byte)+int大小(4byte)+Boolean大小(1byte)+空Object引用的大小 (4byte)=17byte。但是因为Java在对对象内存分配时都是以8的整数倍来分，因此大于17byte的最接近8的整数倍的是24，因此此对象 的大小为24byte。</span>
</code></pre>
<p>​    </p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        Author:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">Snowman</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        Link:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://snowmanazz.github.io/2021/07/30/JVM/">http://snowmanazz.github.io/2021/07/30/JVM/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        Reprint policy:
                    </i>
                </span>
                <span class="reprint-info">
                    All articles in this blog are used except for special statements
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    reprint policy. If reproduced, please indicate source
                    <a href="/about" target="_blank">Snowman</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>Copied successfully, please follow the reprint policy of this article</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">more</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/java/">
                                    <span class="chip bg-color">java</span>
                                </a>
                            
                                <a href="/tags/JVM/">
                                    <span class="chip bg-color">JVM</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;Previous</div>
            <div class="card">
                <a href="/2021/07/31/volatile/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/11.jpg" class="responsive-img" alt="深入了解volatile">
                        
                        <span class="card-title">深入了解volatile</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-07-31
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            Snowman
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/volatile/">
                        <span class="chip bg-color">volatile</span>
                    </a>
                    
                    <a href="/tags/%E5%B9%B6%E5%8F%91/">
                        <span class="chip bg-color">并发</span>
                    </a>
                    
                    <a href="/tags/%E7%BA%BF%E7%A8%8B/">
                        <span class="chip bg-color">线程</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                Next&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/07/27/mysql/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/2.jpg" class="responsive-img" alt="mysql">
                        
                        <span class="card-title">mysql</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-07-27
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            Snowman
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/mysql/">
                        <span class="chip bg-color">mysql</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('100# 至少复制多少个字符就追加版权信息.')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE' || selection.getRangeAt(0).commonAncestorContainer.nodeName === 'CODE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + 'From: Idea<br />'
            + 'Author: Snowman<br />'
            + 'Link: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归snowmanazz所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;TOC</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2021-2022</span>
            
            <span id="year">2021</span>
            <a href="/about" target="_blank">Snowman</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;Total visits:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;Total visitors:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
                <span id="sitetime"> Loading ...</span>
                <script>
                    var calcSiteTime = function () {
                        var seconds = 1000;
                        var minutes = seconds * 60;
                        var hours = minutes * 60;
                        var days = hours * 24;
                        var years = days * 365;
                        var today = new Date();
                        var startYear = "2021";
                        var startMonth = "7";
                        var startDate = "10";
                        var startHour = "0";
                        var startMinute = "0";
                        var startSecond = "0";
                        var todayYear = today.getFullYear();
                        var todayMonth = today.getMonth() + 1;
                        var todayDate = today.getDate();
                        var todayHour = today.getHours();
                        var todayMinute = today.getMinutes();
                        var todaySecond = today.getSeconds();
                        var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                        var diff = t2 - t1;
                        var diffYears = Math.floor(diff / years);
                        var diffDays = Math.floor((diff / days) - diffYears * 365);

                        // 区分是否有年份.
                        var language = 'en';
                        if (startYear === String(todayYear)) {
                            document.getElementById("year").innerHTML = todayYear;
                            var daysTip = 'This site has been running for ' + diffDays + ' days';
                            if (language === 'zh-CN') {
                                daysTip = '本站已运行 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                daysTip = '本站已運行 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = daysTip;
                        } else {
                            document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                            var yearsAndDaysTip = 'This site has been running for ' + diffYears + ' years and '
                                + diffDays + ' days';
                            if (language === 'zh-CN') {
                                yearsAndDaysTip = '本站已运行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                yearsAndDaysTip = '本站已運行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = yearsAndDaysTip;
                        }
                    }

                    calcSiteTime();
                </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/Snowmanazz" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:605407716@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=605407716" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 605407716" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;Search</span>
            <input type="search" id="searchInput" name="s" placeholder="Please enter a search keyword"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
